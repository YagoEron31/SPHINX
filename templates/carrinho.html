{% extends "base.html" %}

{% block title %}Carrinho | SPHINX E-SPORTS{% endblock %}

{% block content %}
<section class="pt-32 pb-16 min-h-screen bg-gradient-to-b from-gray-900 to-vortex-dark">
    <div class="container mx-auto px-6 md:px-12">

        <div class="text-center mb-12">
            <h1 class="font-orbitron text-4xl md:text-5xl font-bold text-amber-300 mb-4">SEU ARSENAL</h1>
            <p class="text-gray-400 font-rajdhani text-lg">Revise seus equipamentos antes do checkout.</p>
        </div>

        {% if carrinho|length == 0 %}
        <div
            class="flex flex-col items-center justify-center py-12 border border-gray-800 rounded-lg bg-gray-900/50 backdrop-blur-sm">
            <div class="bg-gray-800 p-6 rounded-full mb-6 animate-float">
                <i data-feather="shopping-cart" class="w-12 h-12 text-gray-500"></i>
            </div>
            <h2 class="font-orbitron text-2xl text-white mb-2">O carrinho está vazio</h2>
            <p class="text-gray-400 mb-8">Parece que você ainda não escolheu seus equipamentos.</p>
            <a href="{{ url_for('loja') }}"
                class="px-8 py-3 golden-gradient text-black font-bold font-orbitron rounded hover:opacity-90 transition transform hover:scale-105">
                VOLTAR À LOJA
            </a>
        </div>
        {% else %}

        <div class="flex flex-col lg:flex-row gap-8">

            <div class="lg:w-2/3 space-y-4">
                {% for item in carrinho %}
                <div
                    class="flex flex-col sm:flex-row items-center bg-gray-900 border border-gray-800 rounded-lg p-4 hover:border-amber-300/50 transition duration-300 group">

                    <div class="w-full sm:w-32 h-32 flex-shrink-0 bg-gray-800 rounded-md overflow-hidden mb-4 sm:mb-0">
                        {% if item.imagem %}
                        <img src="{{ item.imagem }}" alt="{{ item.produto }}"
                            class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-600">
                            <i data-feather="image"></i>
                        </div>
                        {% endif %}
                    </div>

                    <div class="flex-1 sm:ml-6 text-center sm:text-left w-full">
                        <h3 class="font-orbitron text-lg text-white mb-1">{{ item.produto }}</h3>
                        <p class="text-sm text-gray-400 mb-2">Ref: #{{ item.id_produto }}</p>

                        <div class="flex justify-center sm:justify-between items-center mt-4">
                            <div class="text-left">
                                <span class="text-xs text-gray-500 block">Preço Unitário</span>
                                <span class="text-gray-300">R$ {{ "%.2f"|format(item.preco_unitario) }}</span>
                            </div>

                            <div
                                class="flex items-center space-x-2 mx-4 bg-gray-800 rounded px-2 py-1 border border-gray-700">
                                <button
                                    onclick="atualizarQuantidade({{ item.id_item_carrinho }}, {{ item.quantidade }} - 1)"
                                    class="text-gray-400 hover:text-white px-2 transition">-</button>
                                <input type="number" value="{{ item.quantidade }}" min="1"
                                    onchange="atualizarQuantidade({{ item.id_item_carrinho }}, this.value)"
                                    class="w-12 bg-transparent text-center text-amber-300 font-bold focus:outline-none appearance-none">
                                <button
                                    onclick="atualizarQuantidade({{ item.id_item_carrinho }}, {{ item.quantidade }} + 1)"
                                    class="text-gray-400 hover:text-white px-2 transition">+</button>
                            </div>

                            <div class="text-right">
                                <span class="text-xs text-gray-500 block">Total</span>
                                <span class="text-amber-300 font-bold text-lg">R$ {{ "%.2f"|format(item.total_item)
                                    }}</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="removerItem({{ item.id_item_carrinho }})"
                        class="mt-4 sm:mt-0 sm:ml-6 p-2 text-gray-500 hover:text-red-500 hover:bg-red-500/10 rounded-full transition"
                        title="Remover item">
                        <i data-feather="trash-2"></i>
                    </button>
                </div>
                {% endfor %}
            </div>

            <div class="lg:w-1/3">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 sticky top-24">
                    <h3 class="font-orbitron text-xl text-white mb-6 border-b border-gray-800 pb-4">RESUMO DO PEDIDO
                    </h3>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-gray-400">
                            <span>Subtotal</span>
                            <span>R$ {{ "%.2f"|format(total_geral) }}</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Frete</span>
                            <span class="text-green-400">Grátis</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-gray-800 pt-4 mb-8">
                        <span class="font-orbitron text-lg text-white">TOTAL</span>
                        <span class="font-orbitron text-2xl text-amber-300">R$ {{ "%.2f"|format(total_geral) }}</span>
                    </div>

                    <button onclick="finalizarCompra()"
                        class="w-full py-4 golden-gradient text-black font-bold font-orbitron text-lg rounded hover:opacity-90 transition transform active:scale-95 shadow-lg shadow-amber-300/20 flex justify-center items-center gap-2">
                        <span>FINALIZAR COMPRA</span>
                        <i data-feather="check-circle" class="w-5 h-5"></i>
                    </button>

                    <a href="{{ url_for('loja') }}"
                        class="block text-center mt-4 text-gray-500 hover:text-white text-sm transition">
                        Continuar comprando
                    </a>
                </div>
            </div>

        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Função para remover item
    async function removerItem(idItemCarrinho) {
        if (!confirm("Deseja remover este item do arsenal?")) return;

        try {
            const response = await fetch(`/carrinho/remover/${idItemCarrinho}`, {
                method: "POST"
            });

            if (response.ok) {
                // Recarrega a página para atualizar a lista e o total
                window.location.reload();
            } else {
                alert("Erro ao remover item.");
            }
        } catch (error) {
            console.error("Erro:", error);
            alert("Erro de conexão.");
        }
    }

    // Função para finalizar compra
    async function finalizarCompra() {
        if (!confirm("Confirmar a compra de todos os itens?")) return;

        try {
            const response = await fetch("/carrinho/finalizar", {
                method: "POST"
            });
            const data = await response.json();

            if (data.success) {
                window.location.href = "/carrinho"; // Redireciona para home ou uma página de "Meus Pedidos"
            } else {
                alert("Erro ao finalizar: " + data.message);
            }
        } catch (error) {
            console.error("Erro:", error);
            alert("Erro ao processar compra.");
        }
    }

    // Função para atualizar quantidade
    async function atualizarQuantidade(idItem, novaQuantidade) {
        novaQuantidade = parseInt(novaQuantidade);
        if (isNaN(novaQuantidade) || novaQuantidade < 0) return;

        try {
            const response = await fetch("/carrinho/atualizar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id_item: idItem,
                    quantidade: novaQuantidade
                })
            });

            const data = await response.json();

            if (data.success) {
                window.location.reload();
            } else {
                alert("Erro ao atualizar quantidade: " + data.message);
                window.location.reload(); // Recarrega para voltar ao valor original em caso de erro
            }
        } catch (error) {
            console.error("Erro:", error);
            alert("Erro de conexão.");
        }
    }
</script>
{% endblock %}